WITH FiscalYearData AS (
    SELECT 
        SSNUM, 
        SYSCODE, 
        SEQ, 
        EMPR_ID, 
        GET_FISC_YEAR(EFF_DATE) AS EY -- Compute financial year once
    FROM ACCOUNT_HISTORY
)
SELECT 
    AH.SSNUM, AH.SYSCODE, AH.SEQ, AH.EMPR_ID, AH.EMP_IND, AH.TRANS_TYPE, AH.SERVICE_TYPE,
    AH.CERTIFY_IND, AH.EEE_DATE, AH.CONTRIBUTION_TYP,
    AH.ANNUITY_SAVINGS, AH.ACTUAL_EARNINGS, AH.FULL_TIME_EARN_I, AH.SERVICE_YEARS,
    EH.EMP_DATE_YMD, EH.TERMINATION_DATE, '' AS REASON, 0 AS RNUM, 
    FY.EY, -- Use computed financial year from CTE
    EM.EMPLOYER_NAME, EM.EMPR_ADDRESS_1, EM.EMPR_ADDRESS_2, EM.EMPR_CITY, 
    EM.EMPR_STATE, EM.EMPR_ZIP, EC.CONTACT_NAME, 
    MBR.NAME AS MEMBER_NAME, AHC.ACCTHIST_COMMENT,
    EH.EMPR_ID AS EH_EMPR_ID, EH.RIW_LOCATION,
    -- Fixed condition for service description
    CASE 
        WHEN AH.EMP_IND = 'B' AND AH.SERVICE_YEARS = 0 AND AH.SERVICE_TYPE = '00' 
        THEN 'Secondary Service' 
        ELSE 'Standard Service' 
    END AS FIXED_SERVICE_DESC
FROM ACCOUNT_HISTORY AH
LEFT JOIN FiscalYearData FY ON AH.SSNUM = FY.SSNUM AND AH.SYSCODE = FY.SYSCODE AND AH.SEQ = FY.SEQ
LEFT JOIN SERVICE_TYPE_DESC STD ON AH.SERVICE_TYPE = STD.SERVICE_TYPE
LEFT JOIN EMPLOYMENT_HISTORY EH ON AH.SSNUM = EH.SSNUM 
                               AND AH.SYSCODE = EH.SYSCODE 
                               AND AH.EMPR_ID = EH.EMPR_ID
LEFT JOIN EMPLOYER_NAME EM ON EM.EMPLOYER_ID = AH.EMPR_ID 
                          AND EM.SYS_CODE = AH.SYSCODE
LEFT JOIN EMPLOYER_CONTACT EC ON EM.EMPLOYER_ID = EC.EMPLOYER_ID 
                              AND EC.CONTACT_CODE = 'AH'
LEFT JOIN PERSONAL_INFO MBR ON MBR.SSNUM = AH.SSNUM
LEFT JOIN ACCOUNT_HISTORY_COMMENT AHC ON AH.SSNUM = AHC.SSNUM 
                                      AND AH.SYSCODE = AHC.SYSCODE 
                                      AND AHC.ACCT_HIST_SEQ = AH.SEQ
WHERE 
    -- Exclude these records
    NOT (
        (AH.TRANS_TYPE = 'SP' AND AH.EMP_IND IN ('5', '1'))
        OR (AH.TRANS_TYPE IN ('SP', 'MP') AND AH.CERTIFY_IND = 'R')
        OR (AH.TRANS_TYPE = 'MA' AND AH.SERVICE_TYPE < '071')
        OR (AH.TRANS_TYPE IN ('RE', 'SA'))
    )
    -- Include these records
    AND (
        (AH.EMPR_ID = EH.EMPR_ID OR AH.EMPR_ID = 9999) 
        AND AH.EMPR_ID < 0
        OR (AH.TRANS_TYPE = 'MA' AND AH.SERVICE_TYPE = '07' AND AH.CERTIFY_IND = '*')
    )
    AND AH.SSNUM = :P_SSN 
    AND EH.SYSCODE = :P_SYSCODE 
    AND EH.RIW_LOCATION <> 'RIW-ACT1173'
    AND AH.EMP_IND IN ('P', 'B', 'R')
    AND (
        (AH.EFF_DATE BETWEEN EH.EMP_DATE_YMD AND TO_NUMBER(FY.EY || '0630')) 
        OR (AH.EFF_DATE >= EH.EMP_DATE_YMD AND EH.TERMINATION_DATE = 99999999)
    )
    -- Special case handling for Act 37
    OR (
        (AH.EMP_IND = 'R' AND EH.EMP_IND = 'C' AND AH.SERVICE_TYPE = '27' AND EH.RIW_LOCATION = 'RIW-ACT-RET')
    )
ORDER BY AH.SYSCODE, AH.SEQ;
